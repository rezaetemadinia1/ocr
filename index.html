<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<title>OCR فارسی انبوه</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<input type="file" id="fileInput" multiple accept="image/*,.zip" />
<button id="startBtn">شروع OCR</button>
<button id="exportXLSX">خروجی Excel</button>
<table border="1" id="resultTable">
<thead><tr><th>ردیف</th><th>نام فایل</th><th>متن</th><th>اطمینان</th><th>خطا</th></tr></thead>
<tbody></tbody>
</table>
<script>
let tasks = [];
let results = [];

function cleanText(str) {
  if (!str) return '';
  let s = String(str).replace(/\r\n|\r|\n/g, ' ').replace(/\s+/g, ' ').trim();
  s = s.replace(/\u200c/g, '\u200c')
       .replace(/ ?([،,:;؛\.\!\?]) ?/g, '$1 ')
       .replace(/\s{2,}/g, ' ')
       .trim();
  return s;
}

document.getElementById('fileInput').addEventListener('change', e => {
  tasks = Array.from(e.target.files);
});

document.getElementById('startBtn').addEventListener('click', async () => {
  results = [];
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';
  let idx = 1;
  for (const file of tasks) {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${idx}</td><td>${file.name}</td><td>در حال پردازش...</td><td></td><td></td>`;
    tbody.appendChild(row);
    try {
      const res = await Tesseract.recognize(file, 'fas', {
        logger: m => console.log(m),
        langPath: 'https://cdn.jsdelivr.net/gh/naptha/tessdata@master/4.0.0'
      });
      const words = res.data.words || [];
      const confs = words.map(w => (typeof w.conf === 'number' ? w.conf : NaN)).filter(x => !isNaN(x) && x >= 0);
      const avgConf = confs.length ? (confs.reduce((a, b) => a + b, 0) / confs.length) : null;
      const text = cleanText(res.data.text || '');
      row.cells[2].textContent = text;
      row.cells[3].textContent = avgConf !== null ? avgConf.toFixed(1) + '%' : '';
      results.push({ id: idx, name: file.name, text, conf: avgConf, error: '' });
    } catch (err) {
      row.cells[4].textContent = err.message || String(err);
      results.push({ id: idx, name: file.name, text: '', conf: null, error: err.message || String(err) });
    }
    idx++;
  }
});

document.getElementById('exportXLSX').addEventListener('click', () => {
  const ordered = results.map(r => ({
    index: r.id,
    file: r.name,
    text: r.text,
    confidence: r.conf != null ? Number(r.conf.toFixed(1)) : '',
    error: r.error || ''
  }));
  const ws = XLSX.utils.json_to_sheet(ordered, { header: ['index', 'file', 'text', 'confidence', 'error'] });
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'OCR');
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ocr_results.xlsx';
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
