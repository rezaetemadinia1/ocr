<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>استخراج پاسخ‌ها</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; direction: rtl; text-align: right; }
    </style>
</head>
<body>
    <h2>استخراج پاسخ‌های استوری اینستاگرام</h2>
    <input type="file" id="fileInput" multiple accept="image/*">
    <button onclick="processFiles()">شروع OCR</button>
    <button onclick="downloadExcel()">دانلود اکسل</button>
    <pre id="output"></pre>

    <script>
        let allResponses = [];

        async function processFiles() {
            allResponses = [];
            const files = document.getElementById('fileInput').files;
            for (let file of files) {
                const text = await Tesseract.recognize(file, 'fas', {
                    langPath: './tessdata'
                }).then(({ data: { text } }) => text);

                // حذف آیدی و Reply و تمیز کردن متن
                let cleanText = text
                    .replace(/Reply/g, '')
                    .replace(/@[^\s]+/g, '') 
                    .replace(/\n\s*\n/g, '\n') 
                    .trim();

                // هر خط به‌عنوان یک پاسخ
                let responses = cleanText.split('\n').map(r => r.trim()).filter(r => r.length > 0);
                allResponses.push(...responses);
            }
            document.getElementById('output').textContent = allResponses.join("\n");
        }

        function downloadExcel() {
            if (allResponses.length === 0) {
                alert("هیچ پاسخی برای دانلود وجود ندارد!");
                return;
            }
            let ws = XLSX.utils.aoa_to_sheet([["پاسخ‌ها"], ...allResponses.map(r => [r])]);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Responses");
            XLSX.writeFile(wb, "responses.xlsx");
        }
    </script>
</body>
</html>
